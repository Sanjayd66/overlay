<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BGMI PRO ADMIN - STABLE LOGIC</title>
    <style>
        :root { --orange: #ff5a00; --blue: #0088ff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #050505; color: white; display: flex; height: 100vh; overflow: hidden; }
        #admin { width: 750px; background: #111; border-right: 2px solid var(--orange); padding: 15px; overflow-y: auto; }
        .status { background: #000; padding: 12px; border: 1px solid #333; color: #0f0; text-align: center; margin-bottom: 10px; border-left: 5px solid #0f0; font-family: monospace; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn { flex: 1; padding: 12px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; color: white; text-transform: uppercase; }
        .preview-box { position: relative; width: 100%; background: #000; border: 1px solid #444; margin-bottom: 10px; }
        #v { width: 100%; height: auto; display: block; }
        #sel-canvas { position: absolute; top:0; left:0; width:100%; height:100%; cursor: crosshair; }
        .db-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .db-table th { background: #222; color: var(--orange); padding: 8px; text-align: left; }
        .db-table input { background: #000; color: #fff; border: 1px solid #333; width: 85%; padding: 4px; }
        .manual-btn { background: var(--blue); color: white; border: none; padding: 5px; cursor: pointer; font-weight: bold; width: 100%; border-radius: 3px; }
        .ctrl-panel { background: #1a1a1a; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="admin">
    <div id="status" class="status">SYSTEM READY: WAITING FOR CROP</div>
    
    <div class="btn-group">
        <button id="startBtn" class="btn" style="background:var(--orange)">1. START CAPTURE</button>
        <button class="btn" style="background:var(--blue)" onclick="window.open('view.html','_blank')">2. VIEW PANEL</button>
    </div>

    <div class="ctrl-panel">
        <label>Detection Sensitivity: </label>
        <input type="range" id="sens" min="10" max="100" value="50">
        <span id="sensVal">50</span>
    </div>

    <div class="preview-box">
        <video id="v" autoplay playsinline muted></video>
        <canvas id="sel-canvas"></canvas>
    </div>

    <table class="db-table">
        <thead>
            <tr><th>#</th><th>SHOW</th><th>TEAM NAME</th><th>LOGO</th><th>MATCH COLOR</th></tr>
        </thead>
        <tbody id="dbBody"></tbody>
    </table>
</div>

<script>
    const bc = new BroadcastChannel('bgmi_v30_sync');
    const FIREBASE_URL = "https://bgmi-overlay-default-rtdb.firebaseio.com/liveData.json";
    
    const v = document.getElementById('v'), selC = document.getElementById('sel-canvas'), sCtx = selC.getContext('2d');
    let crop = { x: 0, y: 0, w: 0, h: 0, drawing: false };
    let lastSentId = null;
    let teamDB = JSON.parse(localStorage.getItem('bgmi_v30_db')) || {};

    // Initial Team Setup (1-25)
    function render() {
        const tbody = document.getElementById('dbBody'); tbody.innerHTML = "";
        for (let i = 1; i <= 25; i++) {
            if(!teamDB[i]) teamDB[i] = { name: `TEAM ${i}`, logo: `${i}`, sbg: '#ff5a00' };
            tbody.innerHTML += `<tr>
                <td>${i}</td>
                <td><button class="manual-btn" onclick="sendData(${i})">SHOW</button></td>
                <td><input type="text" value="${teamDB[i].name}" onchange="updateDB(${i},'name',this.value)"></td>
                <td><input type="text" value="${teamDB[i].logo}" onchange="updateDB(${i},'logo',this.value)"></td>
                <td><input type="color" value="${teamDB[i].sbg}" onchange="updateDB(${i},'sbg',this.value)"></td>
            </tr>`;
        }
    }

    function updateDB(id, k, val) { teamDB[id][k] = val; localStorage.setItem('bgmi_v30_db', JSON.stringify(teamDB)); }

    function sendData(id) {
        if(!teamDB[id] || id === lastSentId) return;
        const data = {...teamDB[id], slot: id, ts: Date.now()};
        bc.postMessage(data); 
        fetch(FIREBASE_URL, {method:"PUT", body:JSON.stringify(data)});
        document.getElementById('status').innerText = "LIVE: " + teamDB[id].name;
        lastSentId = id;
    }

    document.getElementById('startBtn').onclick = async () => {
        v.srcObject = await navigator.mediaDevices.getDisplayMedia({ video: true });
        v.onloadedmetadata = () => { 
            selC.width = v.clientWidth; selC.height = v.clientHeight; 
            startFingerprintScan();
        };
    };

    function startFingerprintScan() {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');

        setInterval(() => {
            if(!v.srcObject || crop.w < 5) return;

            const sx = v.videoWidth / selC.width, sy = v.videoHeight / selC.height;
            tempCanvas.width = 10; tempCanvas.height = 10; // Chota sample area
            
            // Draw cropped area to small canvas
            tCtx.drawImage(v, crop.x*sx, crop.y*sy, crop.w*sx, crop.h*sy, 0, 0, 10, 10);
            const imgData = tCtx.getImageData(0, 0, 10, 10).data;

            // Fingerprint Calculation: Average Color of the selection
            let r=0, g=0, b=0;
            for(let i=0; i<imgData.length; i+=4) {
                r += imgData[i]; g += imgData[i+1]; b += imgData[i+2];
            }
            r /= 100; g /= 100; b /= 100;

            // Match with Team DB colors
            let bestSlot = null;
            let minDiff = 100000;
            const threshold = document.getElementById('sens').value;

            for(let i=1; i<=25; i++) {
                const hex = teamDB[i].sbg;
                const tr = parseInt(hex.slice(1,3), 16), tg = parseInt(hex.slice(3,5), 16), tb = parseInt(hex.slice(5,7), 16);
                
                // Euclidean Color Distance Logic
                const diff = Math.sqrt(Math.pow(r-tr,2) + Math.pow(g-tg,2) + Math.pow(b-tb,2));
                
                if(diff < minDiff && diff < threshold) {
                    minDiff = diff;
                    bestSlot = i;
                }
            }

            if(bestSlot) {
                sendData(bestSlot);
                document.getElementById('status').innerText = "DETECTED: TEAM " + bestSlot + " (Diff: " + Math.round(minDiff) + ")";
            }
        }, 300);
    }

    // Crop functionality
    selC.onmousedown = (e) => { crop.x = e.offsetX; crop.y = e.offsetY; crop.drawing = true; };
    selC.onmousemove = (e) => { if(crop.drawing) { sCtx.clearRect(0,0,selC.width,selC.height); sCtx.strokeStyle = "#0f0"; sCtx.strokeRect(crop.x, crop.y, e.offsetX-crop.x, e.offsetY-crop.y); } };
    selC.onmouseup = (e) => { crop.w = Math.abs(e.offsetX-crop.x); crop.h = Math.abs(e.offsetY-crop.y); crop.drawing = false; };
    
    document.getElementById('sens').oninput = (e) => document.getElementById('sensVal').innerText = e.target.value;
    render();
</script>
</body>
</html>
