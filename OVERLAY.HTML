<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BGMI AI ADMIN - SLOT LIST IMPORT</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root { --orange: #ff5a00; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: white; display: flex; height: 100vh; overflow: hidden; }
        #admin { width: 500px; background: #111; border-right: 2px solid var(--orange); padding: 15px; overflow-y: auto; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn { flex: 1; padding: 10px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; color: white; text-transform: uppercase; }
        .btn-start { background: var(--orange); }
        .btn-import { background: #28a745; }
        .status { background: #000; padding: 10px; border: 1px solid #333; color: #0f0; font-family: monospace; text-align: center; margin-bottom: 10px; font-size: 16px; border-left: 5px solid #0f0; }
        #import-area { width: 95%; height: 80px; background: #222; color: #ccc; border: 1px solid #444; padding: 8px; font-size: 11px; margin-bottom: 10px; resize: none; }
        .preview-box { position: relative; width: 100%; background: #000; border: 1px solid #444; line-height: 0; margin-bottom: 15px; }
        #v { width: 100%; height: auto; }
        #sel-canvas { position: absolute; top:0; left:0; width:100%; height:100%; cursor: crosshair; }
        #debug-canvas { width: 100%; height: 80px; background: #fff; margin-bottom: 10px; border: 2px solid red; }
        .db-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .db-table input { background: #1a1a1a; color: #fff; border: 1px solid #333; width: 90%; padding: 3px; }
    </style>
</head>
<body>

<div id="admin">
    <div class="status" id="status">AI READY</div>
    
    <div style="font-size: 12px; margin-bottom: 5px; color: var(--orange);">PASTE SLOT LIST HERE:</div>
    <textarea id="import-area" placeholder="05 | TEAM NAME..."></textarea>
    <button class="btn btn-import" onclick="importSlots()">Import Names</button>

    <div class="btn-group" style="margin-top:15px;">
        <button class="btn btn-start" onclick="startApp()">1. Start Capture</button>
        <button class="btn" style="background:#0088ff" onclick="window.open('view.html','_blank')">2. View</button>
    </div>

    <div class="preview-box">
        <video id="v" autoplay muted></video>
        <canvas id="sel-canvas"></canvas>
    </div>
    <div style="font-size:11px;color:grey">AI VIEW (INVERTED FOR ACCURACY):</div>
    <canvas id="debug-canvas"></canvas>

    <table class="db-table">
        <thead><tr><th>#</th><th>TEAM NAME</th><th>LOGO/DRIVE ID</th></tr></thead>
        <tbody id="dbBody"></tbody>
    </table>
</div>

<script>
    const fbURL = "https://bgmi-overlay-default-rtdb.firebaseio.com/liveData.json"; 
    const v = document.getElementById('v'), selC = document.getElementById('sel-canvas'), sCtx = selC.getContext('2d');
    const dC = document.getElementById('debug-canvas'), dCtx = dC.getContext('2d');
    
    let crop = { x: 0, y: 0, w: 0, h: 0, drawing: false };
    let worker = null, lastSentId = null, isScanning = false;
    let voteList = []; 
    const voteLimit = 3; 

    let teamDB = JSON.parse(localStorage.getItem('bgmi_db_v_final')) || {};

    function renderTable() {
        const tbody = document.getElementById('dbBody');
        tbody.innerHTML = "";
        for (let i = 1; i <= 25; i++) {
            if(!teamDB[i]) teamDB[i] = { name: `TEAM ${i}`, logo: `${i}`, bdr: '#ffffff', sbg: '#ff5a00' };
            tbody.innerHTML += `<tr>
                <td>${i}</td>
                <td><input type="text" id="name-${i}" value="${teamDB[i].name}" onchange="updateDB(${i},'name',this.value)"></td>
                <td><input type="text" id="logo-${i}" value="${teamDB[i].logo}" onchange="updateDB(${i},'logo',this.value)"></td>
            </tr>`;
        }
    }
    renderTable();

    // NEW: SLOT IMPORT LOGIC
    function importSlots() {
        const text = document.getElementById('import-area').value;
        const lines = text.split('\n');
        lines.forEach(line => {
            const match = line.match(/(\d+)\s*[|â€¢-]\s*(.*)/);
            if(match) {
                const slot = parseInt(match[1]);
                const name = match[2].trim();
                if(slot >= 1 && slot <= 25) {
                    teamDB[slot].name = name;
                    document.getElementById(`name-${slot}`).value = name;
                }
            }
        });
        localStorage.setItem('bgmi_db_v_final', JSON.stringify(teamDB));
        alert("Slot List Updated Successfully!");
    }

    function updateDB(id, key, val) { 
        teamDB[id][key] = val; 
        localStorage.setItem('bgmi_db_v_final', JSON.stringify(teamDB)); 
        if(lastSentId == id) pushToCloud(teamDB[id]);
    }

    async function pushToCloud(data) {
        try { await fetch(fbURL, { method: 'PUT', body: JSON.stringify(data) }); } catch (e) { }
    }

    async function startApp() {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: { width: 1920, height: 1080 } });
        v.srcObject = stream;
        v.onloadedmetadata = () => { selC.width = v.clientWidth; selC.height = v.clientHeight; initOCR(); };
    }

    async function initOCR() {
        worker = await Tesseract.createWorker('eng');
        await worker.setParameters({ 
            tessedit_char_whitelist: '0123456789TEAMteam',
            tessedit_pageseg_mode: '7'
        });
        document.getElementById('status').innerText = "AI SCANNING...";
        setInterval(scan, 250); 
    }

    async function scan() {
        if(!v.srcObject || crop.w < 5 || isScanning) return;
        isScanning = true;
        const sx = v.videoWidth / selC.width, sy = v.videoHeight / selC.height;
        dC.width = 400; dC.height = 100;
        // OCR ACCURACY BOOST: High Contrast + Invert
        dCtx.filter = "grayscale(1) contrast(8) brightness(0.9) invert(1)"; 
        dCtx.drawImage(v, crop.x*sx, crop.y*sy, crop.w*sx, crop.h*sy, 0, 0, 400, 100);
        
        const { data: { text, confidence } } = await worker.recognize(dC);
        isScanning = false;

        let cleanText = text.toUpperCase().replace(/\s+/g, ""); 
        let match = cleanText.match(/(\d+)/);

        if(confidence > 45 && match) {
            let num = parseInt(match[0]);
            if(num >= 1 && num <= 25) {
                voteList.push(num);
                if(voteList.length >= voteLimit) {
                    const stableId = voteList.reduce((a, b, i, arr) => (arr.filter(v => v === a).length >= arr.filter(v => v === b).length ? a : b));
                    if(stableId !== lastSentId) {
                        lastSentId = stableId;
                        pushToCloud(teamDB[stableId]);
                        document.getElementById('status').innerText = "LOCKED: " + teamDB[stableId].name;
                    }
                    voteList = [];
                }
            }
        }
    }
    selC.onmousedown = (e) => { crop.x = e.offsetX; crop.y = e.offsetY; crop.drawing = true; voteList = []; };
    selC.onmousemove = (e) => { if(crop.drawing) { sCtx.clearRect(0,0,selC.width,selC.height); sCtx.strokeStyle = "#0f0"; sCtx.lineWidth=2; sCtx.strokeRect(crop.x, crop.y, e.offsetX-crop.x, e.offsetY-crop.y); } };
    selC.onmouseup = (e) => { crop.w = Math.abs(e.offsetX-crop.x); crop.h = Math.abs(e.offsetY-crop.y); crop.drawing = false; };
</script>
</body>
</html>
