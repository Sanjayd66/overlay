<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BGMI COLOR ADMIN</title>
  <style>
    :root { --orange:#ff5a00; --blue:#0088ff; --green:#28a745; --red:#dc3545; }
    body{
      margin:0;
      font-family:'Segoe UI',sans-serif;
      background:#050505;
      color:#fff;
      display:flex;
      height:100vh;
    }
    #admin{
      width:720px;
      background:#111;
      border-right:2px solid var(--orange);
      padding:15px;
      overflow-y:auto;
    }
    .status{
      background:#000;
      margin-bottom:10px;
      padding:10px;
      border:1px solid #333;
      border-left:5px solid #0f0;
      font-size:15px;
      text-align:center;
    }
    .btn-group{
      display:flex;
      gap:10px;
      margin-bottom:10px;
    }
    .btn{
      flex:1;
      padding:10px;
      border:none;
      border-radius:4px;
      color:#fff;
      font-weight:bold;
      cursor:pointer;
      font-size:12px;
      text-transform:uppercase;
    }
    #import-area{
      width:95%;
      height:60px;
      background:#1a1a1a;
      color:#0f0;
      border:1px solid #333;
      padding:6px;
      font-size:11px;
      border-radius:4px;
      resize:none;
      margin-bottom:5px;
    }
    .preview-box{
      position:relative;
      width:100%;
      background:#000;
      border:1px solid #444;
      margin-bottom:10px;
      line-height:0;
    }
    #v{width:100%;background:#222;}
    #sel-canvas{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      cursor:crosshair;
    }
    #debug-canvas{
      width:100%;
      height:90px;
      background:#000;
      border:1px solid #0f0;
      margin-bottom:10px;
    }
    .metrics{
      display:flex;
      gap:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .metric{
      background:#222;
      padding:6px 10px;
      border-radius:4px;
    }
    .db-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .db-table th{
      background:#222;
      color:var(--orange);
      padding:6px;
      text-align:left;
    }
    .db-table td{padding:4px;}
    .db-table tr.off{opacity:.3;}
    .db-table input{
      background:#000;
      color:#fff;
      border:1px solid #333;
      width:90%;
      padding:3px;
      font-size:11px;
    }
    .toggle-btn{
      cursor:pointer;
      padding:3px 6px;
      border-radius:3px;
      border:none;
      font-weight:bold;
      font-size:10px;
    }
    .on{background:var(--green);color:#fff;}
    .off-btn{background:#444;color:#aaa;}
    .manual-show{
      background:var(--blue);
      color:#fff;
      border:none;
      padding:4px;
      border-radius:3px;
      cursor:pointer;
      font-size:10px;
      width:100%;
      font-weight:bold;
    }
  </style>
</head>
<body>
<div id="admin">
  <div id="status" class="status">
    READY: START CAPTURE, PHIR SLOT COLOR AREA CROP KARO
  </div>

  <div class="metrics">
    <div class="metric">Avg R: <span id="mR">0</span></div>
    <div class="metric">Avg G: <span id="mG">0</span></div>
    <div class="metric">Avg B: <span id="mB">0</span></div>
    <div class="metric">Slot: <span id="mWin">-</span></div>
  </div>

  <div class="btn-group">
    <button id="startBtn" class="btn" style="background:var(--orange)">START CAPTURE</button>
    <button class="btn" style="background:var(--blue)" onclick="window.open('view.html','_blank')">OPEN VIEW</button>
  </div>

  <textarea id="import-area" placeholder="1 | TEAM K9
2 | TEAM XYZ
3 | TEAM ABC"></textarea>
  <button class="btn" style="background:#333;width:100%;margin-bottom:10px;" onclick="importSlots()">
    UPDATE SLOT LIST
  </button>

  <div style="font-size:11px;margin-bottom:6px;">
    NOTE: Crop sirf us chhote color box par rakho jahan current slot ka flat color dikh raha hai (number ignore karo).[file:11]
  </div>

  <div class="preview-box">
    <video id="v" autoplay playsinline muted></video>
    <canvas id="sel-canvas"></canvas>
  </div>

  <canvas id="debug-canvas"></canvas>

  <table class="db-table">
    <thead>
      <tr>
        <th>#</th><th>ON</th><th>SHOW</th><th>TEAM NAME</th><th>LOGO/TEXT</th><th>BG COLOR</th>
      </tr>
    </thead>
    <tbody id="dbBody"></tbody>
  </table>
</div>

<script>
  // ===== CONFIG =====
  const FIREBASE_URL = "https://bgmi-overlay-default-rtdb.firebaseio.com/liveData.json";

  // YAHAN APNE REAL RGB VALUES BHARO (slot 1–25, chart ke hisaab se)
  // Example numbers placeholder hain, inko apne screenshot se replace karo.
  const slotColors = {
    1:{r: 15,g: 80,b:160},
    2:{r: 20,g:150,b: 90},
    3:{r:120,g: 40,b:150},
    4:{r: 30,g:130,b:190},
    5:{r:200,g: 90,b: 40},
    6:{r: 20,g:130,b:120},
    7:{r:160,g:130,b: 40},
    8:{r:200,g: 60,b:140},
    9:{r: 80,g:180,b: 60},
    10:{r: 20,g:110,b:190},
    11:{r:210,g:150,b: 40},
    12:{r: 40,g:170,b:200},
    13:{r:120,g: 80,b:200},
    14:{r:220,g:110,b: 60},
    15:{r: 60,g:140,b: 90},
    16:{r: 30,g:110,b:180},
    17:{r:190,g:140,b: 40},
    18:{r:170,g: 60,b:180},
    19:{r: 40,g:160,b: 80},
    20:{r: 20,g:120,b:200},
    21:{r:200,g:130,b: 80},
    22:{r: 60,g:170,b:200},
    23:{r:130,g: 90,b:210},
    24:{r:220,g: 80,b:120},
    25:{r: 80,g:160,b:100}
  };

  const v = document.getElementById('v');
  const selC = document.getElementById('sel-canvas');
  const sCtx = selC.getContext('2d');
  const dC = document.getElementById('debug-canvas');
  const dCtx = dC.getContext('2d');

  let crop = {x:0,y:0,w:0,h:0,drawing:false};
  let scanning = false;
  let votes = {}, scanCount = 0, lastSlot = null;

  let teamDB = JSON.parse(localStorage.getItem('bgmi_v23_db') || '{}');
  let activeSlots = Array(26).fill(true);

  function renderTable(){
    const tb = document.getElementById('dbBody');
    tb.innerHTML = "";
    for(let i=1;i<=25;i++){
      if(!teamDB[i]) teamDB[i]={name:`TEAM ${i}`,logo:`${i}`,sbg:'#28a745'};
      const t=teamDB[i], on=!!activeSlots[i];
      tb.innerHTML += `
        <tr class="${on?'':'off'}">
          <td>${i}</td>
          <td><button class="toggle-btn ${on?'on':'off-btn'}" onclick="toggleSlot(${i})">${on?'ON':'OFF'}</button></td>
          <td><button class="manual-show" onclick="pushSlot(${i});pushToFirebase(${i});">SHOW</button></td>
          <td><input value="${t.name}" onchange="updateDB(${i},'name',this.value)"></td>
          <td><input value="${t.logo}" onchange="updateDB(${i},'logo',this.value)"></td>
          <td><input type="color" value="${t.sbg}" onchange="updateDB(${i},'sbg',this.value)"></td>
        </tr>`;
    }
  }
  renderTable();

  function saveDB(){
    localStorage.setItem('bgmi_v23_db',JSON.stringify(teamDB));
  }
  function toggleSlot(i){
    activeSlots[i]=!activeSlots[i];
    renderTable();
  }
  function updateDB(i,k,v){
    teamDB[i][k]=v;
    saveDB();
  }

  function importSlots(){
    const text=document.getElementById('import-area').value;
    text.split('\n').forEach(line=>{
      const m=line.match(/(\d+)\s*[|•-]\s*(.+)/);
      if(m){
        const slot=parseInt(m[1],10);
        if(slot>=1 && slot<=25){
          if(!teamDB[slot]) teamDB[slot]={};
          teamDB[slot].name=m[2].trim();
        }
      }
    });
    saveDB();
    renderTable();
    document.getElementById('status').textContent="SLOT LIST UPDATED";
  }

  function pushSlot(slot){
    const t=teamDB[slot];
    if(!t) return;
    lastSlot = slot;
    localStorage.setItem('bgmi_v23_push', JSON.stringify({
      slot,
      name:t.name,
      logo:t.logo,
      sbg:t.sbg,
      ts:Date.now()
    }));
    document.getElementById('status').textContent=`LIVE: ${t.name} (SLOT ${slot})`;
    document.getElementById('mWin').textContent = slot;
  }

  async function pushToFirebase(slot){
    const t = teamDB[slot];
    if(!t) return;
    const payload = {
      slot: slot,
      name: t.name,
      logo: t.logo,
      sbg: t.sbg,
      ts: Date.now()
    };
    try{
      await fetch(FIREBASE_URL,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }catch(e){
      console.log("Firebase push failed",e);
    }
  }

  // ===== SCREEN CAPTURE =====
  document.getElementById('startBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('startBtn');
    btn.disabled=true;
    btn.textContent="CAPTURE...";
    try{
      const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
      v.srcObject = stream;
      v.onloadedmetadata = ()=>{
        selC.width = v.clientWidth;
        selC.height = v.clientHeight;
        document.getElementById('status').textContent =
          "COLOR DETECT RUNNING – SLOT COLOR AREA CROP KARO";
        scanLoop();
        btn.textContent="RUNNING (REFRESH TO STOP)";
      };
    }catch(e){
      document.getElementById('status').textContent="SCREEN CAPTURE BLOCKED";
      btn.disabled=false;
      btn.textContent="START CAPTURE";
    }
  });

  function getAverageColor(img){
    const d = img.data;
    let r=0,g=0,b=0,count=0;
    for(let i=0;i<d.length;i+=4){
      r+=d[i];
      g+=d[i+1];
      b+=d[i+2];
      count++;
    }
    return {r:r/count,g:g/count,b:b/count};
  }

  function closestSlot(col){
    let bestSlot=null, bestDist=1e12;
    for(const s in slotColors){
      const c = slotColors[s];
      const dr = col.r - c.r;
      const dg = col.g - c.g;
      const db = col.b - c.b;
      const dist = dr*dr + dg*dg + db*db;
      if(dist < bestDist){
        bestDist = dist;
        bestSlot = parseInt(s,10);
      }
    }
    return bestSlot;
  }

  async function scanLoop(){
    await scanOnce();
    requestAnimationFrame(scanLoop);
  }

  async function scanOnce(){
    if(!v.srcObject || crop.w<10 || scanning) return;
    scanning = true;
    try{
      const sx = v.videoWidth / selC.width;
      const sy = v.videoHeight / selC.height;

      dC.width = 80;
      dC.height = 30;
      dCtx.clearRect(0,0,dC.width,dC.height);
      dCtx.drawImage(
        v,
        crop.x*sx, crop.y*sy, crop.w*sx, crop.h*sy,
        0,0,dC.width,dC.height
      );

      const img = dCtx.getImageData(0,0,dC.width,dC.height);
      const avg = getAverageColor(img);

      document.getElementById('mR').textContent = Math.round(avg.r);
      document.getElementById('mG').textContent = Math.round(avg.g);
      document.getElementById('mB').textContent = Math.round(avg.b);

      const num = closestSlot(avg);

      if(num>=1 && num<=25 && activeSlots[num]){
        votes[num] = (votes[num]||0)+1;
        scanCount++;

        // 6 frames ki majority se slot lock hoga
        if(scanCount>=6){
          let best=null,bestV=-1;
          Object.keys(votes).forEach(k=>{
            if(votes[k]>bestV){
              bestV=votes[k];
              best=parseInt(k,10);
            }
          });
          if(best && best!==lastSlot){
            pushSlot(best);
            pushToFirebase(best);
          }
          votes={};
          scanCount=0;
        }
      }

      if(scanCount>20){
        votes={};
        scanCount=0;
      }
    }catch(e){
      console.error(e);
    }
    scanning = false;
  }

  // ===== CROP SELECTION =====
  selC.onmousedown = e=>{
    crop.x=e.offsetX;
    crop.y=e.offsetY;
    crop.drawing=true;
  };
  selC.onmousemove = e=>{
    if(!crop.drawing) return;
    sCtx.clearRect(0,0,selC.width,selC.height);
    sCtx.strokeStyle="#0f0";
    sCtx.lineWidth=2;
    sCtx.strokeRect(crop.x,crop.y,e.offsetX-crop.x,e.offsetY-crop.y);
  };
  selC.onmouseup = e=>{
    crop.w=Math.abs(e.offsetX-crop.x);
    crop.h=Math.abs(e.offsetY-crop.y);
    crop.drawing=false;
    sCtx.clearRect(0,0,selC.width,selC.height);
    if(crop.w>5 && crop.h>5){
      sCtx.strokeStyle="#0f0";
      sCtx.lineWidth=2;
      sCtx.strokeRect(crop.x,crop.y,crop.w,crop.h);
      document.getElementById('status').textContent =
        `CROP OK: ${Math.round(crop.w)}x${Math.round(crop.h)} – SIRF SLOT COLOR BOX COVER KARE`;
    }
  };
</script>
</body>
</html>
